{% extends "base.html" %}
{% block content %}
<style>
  #mindmap {
    width: 100%;
    height: 800px;
    border: 1px solid var(--b);
    border-radius: 8px;
    background: #fff;
    overflow: hidden;
  }
  
  .controls {
    margin: 0.5rem 0;
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
  }
  
  /* Cytoscape node styling for caret shape */
  .cy-node {
    background: linear-gradient(90deg, #1a7 0%, #1a7 calc(100% - 8px), transparent calc(100% - 8px));
    clip-path: polygon(0 0, calc(100% - 8px) 0, 100% 50%, calc(100% - 8px) 100%, 0 100%);
    border-radius: 4px;
    padding: 8px 16px 8px 12px;
    color: white;
    font-weight: 500;
    font-size: 12px;
    text-align: center;
    border: 2px solid white;
  }
  
  .cy-node.root {
    background: linear-gradient(90deg, #1976d2 0%, #1976d2 calc(100% - 8px), transparent calc(100% - 8px));
  }
  
  .cy-node:hover {
    background: linear-gradient(90deg, #0d5 0%, #0d5 calc(100% - 8px), transparent calc(100% - 8px));
  }
</style>

<h2>Mind Map</h2>
<p class="small">
  Interactive visualization of goal hierarchy. Drag to pan, scroll to zoom, click nodes to manage.
</p>

<div class="controls">
  <button class="btn" id="zoomIn">+ Zoom In</button>
  <button class="btn" id="zoomOut">- Zoom Out</button>
  <button class="btn" id="resetView">Reset View</button>
</div>

<div id="mindmap"></div>

<!-- Goal Actions Modal -->
<div class="modal hidden" id="linkModal">
  <div class="content" style="max-width:480px;">
    <h3 id="linkTitle" style="margin-bottom:.25rem;">Goal Name</h3>
    
    <!-- Goal Details -->
    <div style="background:#f5f5f5; border-radius:6px; padding:.75rem; margin-bottom:1rem;">
      <div style="display:grid; grid-template-columns: 80px 1fr; gap:.25rem .5rem; font-size:.9em;">
        <span style="color:#666;">Due:</span>
        <span id="goalDueDisplay">-</span>
        <span style="color:#666;">Parents:</span>
        <span id="goalParentsDisplay">None</span>
        <span style="color:#666;">Children:</span>
        <span id="goalChildrenDisplay">None</span>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem;">
      <a class="btn" id="btnEditGoal" href="#" style="text-align:center; text-decoration:none;">‚úèÔ∏è Edit</a>
      <button class="btn" id="btnAddParent" type="button" style="background:#1976d2;">+ Add Parent</button>
      <a class="btn" id="btnManageParents" href="#" style="text-align:center; text-decoration:none;">üëÜ Manage Parents</a>
      <button class="btn" id="btnAddChild" type="button" style="background:#1976d2;">+ Add Child</button>
      <a class="btn" id="btnManageChildren" href="#" style="text-align:center; text-decoration:none;">üëá Manage Children</a>
    </div>
    
    <div class="actions" style="margin-top:1rem;">
      <button class="btn" id="link_cancel" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Create & Link Goal Modal -->
<div class="modal hidden" id="createGoalModal">
  <div class="content" style="max-width:480px;">
    <h3 id="createGoalTitle">Create New Parent</h3>
    <p id="createGoalSubtitle" style="color:#666; margin:-.25rem 0 .75rem 0; font-size:.9em;"></p>
    
    <label style="font-weight:500; display:block; margin-bottom:.25rem;">Goal Name *</label>
    <input type="text" id="newGoalName" placeholder="Enter goal name..." style="width:100%; padding:.5rem; margin-bottom:.75rem;">
    
    <label style="font-weight:500; display:block; margin-bottom:.25rem;">Due Date</label>
    <input type="date" id="newGoalDue" style="width:100%; padding:.5rem; margin-bottom:.75rem;">
    
    <label style="font-weight:500; display:block; margin-bottom:.25rem;">Description</label>
    <textarea id="newGoalDesc" placeholder="Optional description..." style="width:100%; padding:.5rem; margin-bottom:.75rem; min-height:60px;"></textarea>
    
    <button class="btn" id="createGoalBtn" type="button" style="width:100%; background:#1976d2;">Create & Link Goal</button>
    
    <div class="actions" style="margin-top:1rem;">
      <button class="btn" id="createGoal_cancel" type="button">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" style="position:fixed; bottom:1rem; right:1rem; background:#333; color:#fff; padding:.75rem 1.25rem; border-radius:6px; opacity:0; transition:opacity .3s; pointer-events:none; z-index:1001;"></div>

<script src="https://cdn.jsdelivr.net/npm/cytoscape@3.27.0/dist/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.min.js"></script>
<script>
const DATA = {{ data|tojson }};
const GOALS = DATA.goals || [];
const EDGES = DATA.edges || [];

// Build lookup maps
const goalById = new Map(GOALS.map(g => [g.id, g]));

// Build parent-child relationships
const childrenByParent = new Map();
const parentByChild = new Map();
EDGES.forEach(e => {
  if (!childrenByParent.has(e.parent)) {
    childrenByParent.set(e.parent, []);
  }
  childrenByParent.get(e.parent).push(e.child);
  
  if (!parentByChild.has(e.child)) {
    parentByChild.set(e.child, []);
  }
  parentByChild.get(e.child).push(e.parent);
});

// Find root nodes (nodes without parents)
const rootIds = GOALS.filter(g => !parentByChild.has(g.id) || parentByChild.get(g.id).length === 0).map(g => g.id);

// Build Cytoscape elements
const nodes = [];
const edges = [];

// Add all goals as nodes
GOALS.forEach(goal => {
  const isRoot = rootIds.includes(goal.id);
  const label = goal.name.length > 30 ? goal.name.substring(0, 30) + '...' : goal.name;
  // Estimate node size based on label length
  const labelWidth = Math.min(label.length * 7, 150);
  const labelHeight = 30;
  
  nodes.push({
    data: {
      id: `goal-${goal.id}`,
      label: label,
      width: labelWidth,
      height: labelHeight,
      goalId: goal.id,
      isRoot: isRoot
    },
    classes: isRoot ? 'root' : ''
  });
});

// Add all edges
EDGES.forEach(edge => {
  edges.push({
    data: {
      id: `edge-${edge.parent}-${edge.child}`,
      source: `goal-${edge.parent}`,
      target: `goal-${edge.child}`
    }
  });
});

// If multiple roots, create a virtual root node
let elements = [...nodes, ...edges];
if (rootIds.length > 1) {
  // Add virtual root
  elements.unshift({
    data: {
      id: 'root',
      label: 'Roadmap',
      width: 100,
      height: 30,
      goalId: 0,
      isRoot: true
    },
    classes: 'root'
  });
  
  // Connect virtual root to all real roots
  rootIds.forEach(rootId => {
    elements.push({
      data: {
        id: `edge-root-${rootId}`,
        source: 'root',
        target: `goal-${rootId}`
      }
    });
  });
}

// Initialize Cytoscape
let cy = cytoscape({
  container: document.getElementById('mindmap'),
  elements: elements,
  style: [
    {
      selector: 'node',
      style: {
        'label': 'data(label)',
        'width': 'data(width)',
        'height': 'data(height)',
        'shape': 'round-rectangle',
        'background-color': '#1a7',
        'border-color': '#fff',
        'border-width': 2,
        'color': '#fff',
        'text-valign': 'center',
        'text-halign': 'center',
        'font-size': '12px',
        'font-weight': '500',
        'padding': '8px',
        'text-wrap': 'wrap',
        'text-max-width': '150px',
        'text-overflow': 'ellipsis'
      }
    },
    {
      selector: 'node.root',
      style: {
        'background-color': '#1976d2'
      }
    },
    {
      selector: 'edge',
      style: {
        'width': 2,
        'line-color': '#ccc',
        'target-arrow-color': '#ccc',
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier',
        'source-endpoint': 'outside-to-node',
        'target-endpoint': 'outside-to-node'
      }
    }
  ],
  layout: {
    name: 'dagre',
    rankDir: 'LR',
    nodeSep: 50,
    rankSep: 100,
    spacingFactor: 1.2
  },
  minZoom: 0.1,
  maxZoom: 4
});

// Handle node clicks
cy.on('tap', 'node', function(evt) {
  const node = evt.target;
  const goalId = node.data('goalId');
  if (goalId && goalId !== 0) {
    openLinkModal(goalId);
  }
});

// ---------- Modal Setup ----------
const linkModal = document.getElementById('linkModal');
const linkTitle = document.getElementById('linkTitle');
const goalDueDisplay = document.getElementById('goalDueDisplay');
const goalParentsDisplay = document.getElementById('goalParentsDisplay');
const goalChildrenDisplay = document.getElementById('goalChildrenDisplay');
const btnEditGoal = document.getElementById('btnEditGoal');
const btnAddParent = document.getElementById('btnAddParent');
const btnAddChild = document.getElementById('btnAddChild');
const btnManageParents = document.getElementById('btnManageParents');
const btnManageChildren = document.getElementById('btnManageChildren');
const linkCancel = document.getElementById('link_cancel');

// Create Goal Modal
const createGoalModal = document.getElementById('createGoalModal');
const createGoalTitle = document.getElementById('createGoalTitle');
const createGoalSubtitle = document.getElementById('createGoalSubtitle');
const newGoalName = document.getElementById('newGoalName');
const newGoalDue = document.getElementById('newGoalDue');
const newGoalDesc = document.getElementById('newGoalDesc');
const createGoalBtn = document.getElementById('createGoalBtn');
const createGoalCancel = document.getElementById('createGoal_cancel');

const toast = document.getElementById('toast');

let selectedGoalId = null;
let createMode = null; // 'parent' or 'child'

function showToast(msg, isError = false) {
  toast.textContent = msg;
  toast.style.background = isError ? '#d32f2f' : '#388e3c';
  toast.style.opacity = '1';
  setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

// Get parents and children for a goal
function getGoalRelationships(goalId) {
  const parents = [];
  const children = [];
  EDGES.forEach(e => {
    if (e.child === goalId) {
      const parent = goalById.get(e.parent);
      if (parent) parents.push(parent.name);
    }
    if (e.parent === goalId) {
      const child = goalById.get(e.child);
      if (child) children.push(child.name);
    }
  });
  return { parents, children };
}

function openLinkModal(goalId) {
  const goal = goalById.get(goalId);
  if (!goal) return;
  
  selectedGoalId = goalId;
  
  // Set goal details
  linkTitle.textContent = goal.name;
  goalDueDisplay.textContent = goal.due || '-';
  
  const rels = getGoalRelationships(goalId);
  goalParentsDisplay.textContent = rels.parents.length ? rels.parents.join(', ') : 'None';
  goalChildrenDisplay.textContent = rels.children.length ? rels.children.join(', ') : 'None';
  
  // Set links
  btnEditGoal.href = `/goals`;
  btnManageParents.href = `/links/parents/${goalId}`;
  btnManageChildren.href = `/links/goal/${goalId}`;
  
  linkModal.classList.remove('hidden');
}

function closeLinkModal() {
  linkModal.classList.add('hidden');
  selectedGoalId = null;
}

// ---------- Create Goal Modal ----------
function openCreateGoalModal(mode) {
  createMode = mode;
  const goal = goalById.get(selectedGoalId);
  
  if (mode === 'parent') {
    createGoalTitle.textContent = 'Create New Parent';
    createGoalSubtitle.textContent = `This new goal will become a parent of "${goal.name}"`;
  } else {
    createGoalTitle.textContent = 'Create New Child';
    createGoalSubtitle.textContent = `This new goal will become a child of "${goal.name}"`;
  }
  
  newGoalName.value = '';
  newGoalDue.value = '';
  newGoalDesc.value = '';
  createGoalModal.classList.remove('hidden');
  newGoalName.focus();
}

function closeCreateGoalModal() {
  createGoalModal.classList.add('hidden');
  createMode = null;
}

async function createAndLinkGoal() {
  const name = newGoalName.value.trim();
  if (!name) {
    showToast('Goal name is required', true);
    newGoalName.focus();
    return;
  }
  
  const due = newGoalDue.value;
  const desc = newGoalDesc.value.trim();
  
  let url;
  if (createMode === 'parent') {
    url = `/goals/${selectedGoalId}/create-and-link-parent`;
  } else {
    url = `/goals/${selectedGoalId}/create-and-link-child`;
  }
  
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, due_date: due, description: desc })
    });
    const data = await resp.json();
    
    if (data.ok) {
      const selectedGoal = goalById.get(selectedGoalId);
      if (createMode === 'parent') {
        showToast(`Created "${name}" as parent of "${selectedGoal.name}"`);
      } else {
        showToast(`Created "${name}" as child of "${selectedGoal.name}"`);
      }
      closeCreateGoalModal();
      closeLinkModal();
      // Reload page to get fresh data
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showToast(data.error || 'Failed to create goal', true);
    }
  } catch (err) {
    showToast('Network error: ' + err.message, true);
  }
}

// Event listeners - Main modal
linkCancel.addEventListener('click', closeLinkModal);
linkModal.addEventListener('click', (e) => { if (e.target === linkModal) closeLinkModal(); });
btnAddParent.addEventListener('click', () => openCreateGoalModal('parent'));
btnAddChild.addEventListener('click', () => openCreateGoalModal('child'));

// Event listeners - Create goal modal
createGoalCancel.addEventListener('click', closeCreateGoalModal);
createGoalModal.addEventListener('click', (e) => { if (e.target === createGoalModal) closeCreateGoalModal(); });
createGoalBtn.addEventListener('click', createAndLinkGoal);
newGoalName.addEventListener('keypress', (e) => { if (e.key === 'Enter') createAndLinkGoal(); });

// Control buttons
document.getElementById('zoomIn').addEventListener('click', () => {
  cy.zoom(cy.zoom() * 1.2);
});

document.getElementById('zoomOut').addEventListener('click', () => {
  cy.zoom(cy.zoom() * 0.8);
});

document.getElementById('resetView').addEventListener('click', () => {
  cy.fit();
  cy.center();
});
</script>
{% endblock %}

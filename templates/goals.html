{% extends "base.html" %}
{% block content %}

<style>
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);padding:.5rem .75rem;border-radius:.5rem;box-shadow:0 4px 12px rgba(0,0,0,.15);background:#111;color:#fff;opacity:0;transition:opacity .25s, transform .25s;pointer-events:none;font-size:.875rem}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
.toast.hidden{display:none}
.badge.muted{background:#eee;color:#666}

/* Excel-style smart filters */
.filter-btn {
  position: relative;
  display: inline-block;
  width: 100%;
  padding: .3rem .4rem;
  font-size: .9rem;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
  text-align: left;
  box-sizing: border-box;
}
.filter-btn:hover { background: #f5f5f5; }
.filter-btn.active { border-color: #4CAF50; background: #f0f8f0; }
.filter-btn::after {
  content: '▼';
  float: right;
  font-size: .7rem;
  opacity: 0.5;
}
.filter-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 1000;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0,0,0,.15);
  min-width: 200px;
  max-width: 300px;
  max-height: 300px;
  overflow: hidden;
  display: none;
  margin-top: 2px;
}
.filter-dropdown.show { display: block; }
.filter-search {
  width: 100%;
  padding: .5rem;
  border: none;
  border-bottom: 1px solid #ddd;
  box-sizing: border-box;
  font-size: .9rem;
}
.filter-list {
  max-height: 200px;
  overflow-y: auto;
  padding: .25rem 0;
}
.filter-item {
  padding: .4rem .75rem;
  display: flex;
  align-items: center;
  cursor: pointer;
}
.filter-item:hover { background: #f5f5f5; }
.filter-item input[type="checkbox"] {
  margin-right: .5rem;
  cursor: pointer;
}
.filter-actions {
  border-top: 1px solid #ddd;
  padding: .5rem;
  display: flex;
  gap: .5rem;
}
.filter-actions button {
  flex: 1;
  padding: .4rem;
  font-size: .85rem;
}
th.filter-cell { position: relative; padding: 0; }
th.filter-cell > div { padding: .5rem; }
#goalsTable td { vertical-align: top; }
#goalsTable td .goal-children-link { margin-top: 0; }
</style>

<h2>Goals</h2>
<div class="row-actions" style="margin:.5rem 0;">
  <button class="btn primary" id="g_add">Add Goal</button>
</div>
<div id="toast" class="toast hidden">Saved</div>

<table id="goalsTable">
  <thead>
    <tr>
      <th class="filter-cell"><div>ID</div></th>
      <th class="filter-cell"><div>Name</div></th>
      <th class="filter-cell"><div>Start</div></th>
      <th class="filter-cell"><div>Due</div></th>
      <th class="filter-cell"><div>Description</div></th>
      <th class="filter-cell"><div>Display</div></th>
      <th class="filter-cell"><div>Tags</div></th>
      <th class="filter-cell"><div>Parents</div></th>
      <th class="filter-cell"><div>Children</div></th>
      <th><div>Edit</div></th>
    </tr>
    <tr class="filter-row">
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th class="filter-cell"></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for g in goals %}
    <tr>
      <td>{{ g.id }}</td>
      <td>{{ g.name }}</td>
      <td>{{ g.start_date_disp or '' }}</td>
      <td>{{ g.due_date_disp }}</td>
      <td>{{ g.description or '' }}</td>
      <td>{{ g.display }}</td>
      <td>{{ g.tags or '' }}</td>
      <td>
        <div style="display: flex; gap: .25rem; flex-wrap: wrap;">
          <a href="/links/parents/{{ g.id }}" class="btn outline small goal-parents-link"
       data-id="{{ g.id }}">Manage Parents</a>
          <button class="btn outline small goal-add-parent" data-id="{{ g.id }}">Add Parent</button>
        </div>
        {% if g.parent_names %}
        <div style="margin-top: .5rem;">
          {% for t in g.parent_names %}<span class="badge">{{ t }}</span>{% endfor %}
        </div>
        {% endif %}
      </td>
      <td>
        <div style="display: flex; gap: .25rem; flex-wrap: wrap;">
          <a href="/links/goal/{{ g.id }}" class="btn outline small goal-children-link"
       data-id="{{ g.id }}">Manage Children</a>
          <button class="btn outline small goal-add-child" data-id="{{ g.id }}">Add Child</button>
        </div>
        {% if g.children_names %}
        <div style="margin-top: .5rem;">
          {% for t in g.children_names %}<span class="badge">{{ t }}</span>{% endfor %}
        </div>
        {% endif %}
      </td>
      
      <td><button class="btn g-edit" data-id="{{ g.id }}">Edit</button></td>
      <td><button class="btn outline danger g-del{% if g.children_names or g.parent_names %} disabled{% endif %}" data-id="{{ g.id }}" data-haslinks="{{ 1 if (g.children_names or g.parent_names) else 0 }}">Delete{% if g.children_names or g.parent_names %} <span class="badge muted" title="Linked to other goals">linked</span>{% endif %}</button></td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<div class="modal hidden" id="goalModal">
  <div class="content">
    <h3 id="goalModalTitle">Edit Goal</h3>
    <form id="goalForm" class="kv">
      <input type="hidden" id="g_id">
      <label>Name</label><input id="g_name" required>
      <label>Start date</label><input id="g_start" type="date">
      <label>Due date</label><input id="g_due" type="date">
      <label>Description</label><textarea id="g_desc"></textarea>
      <label>Display</label><select id="g_display">
        <option value="1">Yes</option>
        <option value="0">No</option>
      </select>
      <label>Tags (comma-separated)</label><input id="g_tags" placeholder="e.g., tag1, tag2, tag3">
      <div class="actions">
        <button type="button" class="btn" id="g_cancel">Cancel</button>
        <button class="btn primary" type="submit" id="g_save">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Manage Children Modal -->
<div class="modal hidden" id="goalChildrenModal">
  <div class="content">
    <h3 id="goalChildrenTitle">Manage Children</h3>
    <div id="goalChildrenBody"></div>
    <div class="actions" style="margin-top:.75rem">
      <button type="button" class="btn" id="goalChildrenClose">Close</button>
    </div>
  </div>
</div>

<!-- Manage Parents Modal -->
<div class="modal hidden" id="goalParentsModal">
  <div class="content">
    <h3 id="goalParentsTitle">Manage Parents</h3>
    <div id="goalParentsBody"></div>
    <div class="actions" style="margin-top:.75rem">
      <button type="button" class="btn" id="goalParentsClose">Close</button>
    </div>
  </div>
</div>

<!-- Add Parent Modal -->
<div class="modal hidden" id="addParentModal">
  <div class="content">
    <h3>Add Parent</h3>
    <div style="margin-bottom: 1rem;">
      <label style="display: flex; gap: 1rem; align-items: center;">
        <input type="radio" name="addParentMode" value="select" checked id="addParentModeSelect">
        <span>Select existing goal</span>
      </label>
      <label style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
        <input type="radio" name="addParentMode" value="create" id="addParentModeCreate">
        <span>Create new goal</span>
      </label>
    </div>
    <form id="addParentForm" class="kv" novalidate>
      <input type="hidden" id="addParentGoalId">
      <div id="addParentSelectSection">
        <label>Select Parent Goal</label>
        <select id="addParentSelect">
          <option value="">-- Select a goal --</option>
        </select>
      </div>
      <div id="addParentCreateSection" style="display: none;">
        <label>Name</label><input id="addParentName" type="text" placeholder="Goal name">
        <label>Start date</label><input id="addParentStart" type="date">
        <label>Due date</label><input id="addParentDue" type="date">
        <label>Description</label><textarea id="addParentDesc" placeholder="Optional description"></textarea>
        <label>Display</label><select id="addParentDisplay">
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
        <label>Tags (comma-separated)</label><input id="addParentTags" type="text" placeholder="e.g., tag1, tag2, tag3">
      </div>
      <div class="actions">
        <button type="button" class="btn" id="addParentCancel">Cancel</button>
        <button class="btn primary" type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Child Modal -->
<div class="modal hidden" id="addChildModal">
  <div class="content">
    <h3>Add Child</h3>
    <div style="margin-bottom: 1rem;">
      <label style="display: flex; gap: 1rem; align-items: center;">
        <input type="radio" name="addChildMode" value="select" checked id="addChildModeSelect">
        <span>Select existing goal</span>
      </label>
      <label style="display: flex; gap: 1rem; align-items: center; margin-top: 0.5rem;">
        <input type="radio" name="addChildMode" value="create" id="addChildModeCreate">
        <span>Create new goal</span>
      </label>
    </div>
    <form id="addChildForm" class="kv" novalidate>
      <input type="hidden" id="addChildGoalId">
      <div id="addChildSelectSection">
        <label>Select Child Goal</label>
        <select id="addChildSelect">
          <option value="">-- Select a goal --</option>
        </select>
      </div>
      <div id="addChildCreateSection" style="display: none;">
        <label>Name</label><input id="addChildName" type="text" placeholder="Goal name">
        <label>Start date</label><input id="addChildStart" type="date">
        <label>Due date</label><input id="addChildDue" type="date">
        <label>Description</label><textarea id="addChildDesc" placeholder="Optional description"></textarea>
        <label>Display</label><select id="addChildDisplay">
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
        <label>Tags (comma-separated)</label><input id="addChildTags" type="text" placeholder="e.g., tag1, tag2, tag3">
      </div>
      <div class="actions">
        <button type="button" class="btn" id="addChildCancel">Cancel</button>
        <button class="btn primary" type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<style>
  /* Tidy the checkbox list in this modal */
  #goalChildrenBody form { margin-top:.25rem; }
  #goalChildrenBody form > div { margin:.35rem 0; }
  #goalChildrenBody label { display:inline-flex; align-items:center; gap:.5rem; line-height:1.3; }
  #goalParentsBody form { margin-top:.25rem; }
  #goalParentsBody form > div { margin:.35rem 0; }
  #goalParentsBody label { display:inline-flex; align-items:center; gap:.5rem; line-height:1.3; }
</style>

<!-- Delete Confirm Modal -->
<div class="modal hidden" id="goalDelModal">
  <div class="content">
    <h3>Delete Goal</h3>
    <p id="goalDelMsg">Are you sure you want to delete this goal?</p>
    <div class="actions">
      <button type="button" class="btn" id="gdel_cancel">Cancel</button>
      <button type="button" class="btn primary danger" id="gdel_confirm">Delete</button>
    </div>
  </div>
</div>

<script>
const GOALS = {{ goals|tojson }};
const ALL_GOALS = {{ all_goals|tojson }};
const gM = document.getElementById('goalModal');
const gF = document.getElementById('goalForm');
const gId = document.getElementById('g_id');
const gName = document.getElementById('g_name');
const gStart = document.getElementById('g_start');
const gDue = document.getElementById('g_due');
const gDesc = document.getElementById('g_desc');
const gDisplay = document.getElementById('g_display');
const gTags = document.getElementById('g_tags');
const gCancel = document.getElementById('g_cancel');
const gTitleEl = document.getElementById('goalModalTitle');
const gSaveBtn = document.getElementById('g_save');

const gAdd = document.getElementById('g_add');
gAdd.addEventListener('click', ()=>{
  gId.value = '';
  gName.value = '';
  gStart.value = '';
  gDue.value = '';
  gDesc.value = '';
  gDisplay.value = '1'; // Default to Yes
  gTags.value = '';
  gTitleEl.textContent = 'Add Goal';
  gSaveBtn.textContent = 'Create';
  gM.classList.remove('hidden');
});


function gOpen(id){
  const row = GOALS.find(r=>r.id===id);
  if(!row) return;
  gTitleEl.textContent = 'Edit Goal';
  gSaveBtn.textContent = 'Save';
  gId.value = id;
  gName.value = row.name||'';
  gStart.value = (row.start_date_disp || '').toString();
  gDue.value = (row.due_date_disp || '').toString();
  gDesc.value = (!row.description || String(row.description).toLowerCase()==='nan')?'':row.description;
  gDisplay.value = (row.display_value !== undefined && row.display_value !== null) ? String(row.display_value) : '1';
  gTags.value = row.tags || '';
  gM.classList.remove('hidden');
}
function gClose(){ gM.classList.add('hidden'); }

document.querySelectorAll('.g-edit').forEach(b=>b.addEventListener('click', ()=> gOpen(parseInt(b.dataset.id,10))));
gCancel.addEventListener('click', gClose);
gM.addEventListener('click', e=>{ if(e.target===gM) gClose(); });

gF.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = gId.value.trim();
  const fd = new FormData();
  fd.append('name', gName.value.trim());
  fd.append('start_date', gStart.value);
  fd.append('due_date', gDue.value);
  fd.append('description', gDesc.value.trim());
  fd.append('display', gDisplay.value || '1');
  fd.append('tags', gTags.value.trim());
  const url = id ? `/goals/${id}/edit-inline` : `/goals/add-inline`;
  const resp = await fetch(url, { method:'POST', body: fd, headers: { 'Accept': 'application/json' } });
  const ct = resp.headers.get('content-type')||'';
  if(!ct.includes('application/json')){ alert('Server returned non-JSON:\n' + await resp.text()); return; }
  const data = await resp.json();
  if(!data.ok){ alert(data.error||'Failed'); return; }
  location.reload();
});


(function(){
  const modal   = document.getElementById('goalChildrenModal');
  const body    = document.getElementById('goalChildrenBody');
  const titleEl = document.getElementById('goalChildrenTitle');
  const closeBtn= document.getElementById('goalChildrenClose');

  function open(){ modal.classList.remove('hidden'); }
  function close(){ modal.classList.add('hidden'); body.innerHTML=''; }

  modal.addEventListener('click', e=>{ if(e.target===modal) close(); });
  closeBtn.addEventListener('click', close);

  document.querySelectorAll('a.goal-children-link').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = a.getAttribute('href');

      // Load existing linker UI and extract only <main>
      const resp = await fetch(url, { headers:{ 'Accept':'text/html' }});
      if(!resp.ok){ alert('Failed to load form'); return; }
      const html = await resp.text();
      const wrap = document.createElement('div'); wrap.innerHTML = html;
      const main = wrap.querySelector('main'); // base layout wraps page body in <main>
      if(!main){ alert('Could not find form'); return; }

      const h2 = main.querySelector('h2');
      const form = main.querySelector('form');
      titleEl.textContent = h2 ? h2.textContent : 'Manage Children';
      if(!form){ body.innerHTML = '<p>No form found.</p>'; open(); return; }

      body.innerHTML = '';
      body.appendChild(form);

      // Inline submit → POST back to same URL, then refresh
      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const fd = new FormData(form);
        const post = await fetch(url, { method:'POST', body: fd });
        if(!post.ok){ alert('Save failed:\n' + await post.text()); return; }
        location.reload();
      });

      open();
    });
  });
})();

(function(){
  const modal   = document.getElementById('goalParentsModal');
  const body    = document.getElementById('goalParentsBody');
  const titleEl = document.getElementById('goalParentsTitle');
  const closeBtn= document.getElementById('goalParentsClose');

  function open(){ modal.classList.remove('hidden'); }
  function close(){ modal.classList.add('hidden'); body.innerHTML=''; }

  modal.addEventListener('click', e=>{ if(e.target===modal) close(); });
  closeBtn.addEventListener('click', close);

  document.querySelectorAll('a.goal-parents-link').forEach(a=>{
    a.addEventListener('click', async (e)=>{
      e.preventDefault();
      const url = a.getAttribute('href');

      // Load existing linker UI and extract only <main>
      const resp = await fetch(url, { headers:{ 'Accept':'text/html' }});
      if(!resp.ok){ alert('Failed to load form'); return; }
      const html = await resp.text();
      const wrap = document.createElement('div'); wrap.innerHTML = html;
      const main = wrap.querySelector('main'); // base layout wraps page body in <main>
      if(!main){ alert('Could not find form'); return; }

      const h2 = main.querySelector('h2');
      const form = main.querySelector('form');
      titleEl.textContent = h2 ? h2.textContent : 'Manage Parents';
      if(!form){ body.innerHTML = '<p>No form found.</p>'; open(); return; }

      body.innerHTML = '';
      body.appendChild(form);

      // Inline submit → POST back to same URL, then refresh
      form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const fd = new FormData(form);
        const post = await fetch(url, { method:'POST', body: fd });
        if(!post.ok){ alert('Save failed:\n' + await post.text()); return; }
        location.reload();
      });

      open();
    });
  });
})();

// Add Parent functionality
(function(){
  const modal = document.getElementById('addParentModal');
  const form = document.getElementById('addParentForm');
  const goalIdInput = document.getElementById('addParentGoalId');
  const select = document.getElementById('addParentSelect');
  const selectSection = document.getElementById('addParentSelectSection');
  const createSection = document.getElementById('addParentCreateSection');
  const modeSelect = document.getElementById('addParentModeSelect');
  const modeCreate = document.getElementById('addParentModeCreate');
  const nameInput = document.getElementById('addParentName');
  const startInput = document.getElementById('addParentStart');
  const dueInput = document.getElementById('addParentDue');
  const descInput = document.getElementById('addParentDesc');
  const displayInput = document.getElementById('addParentDisplay');
  const tagsInput = document.getElementById('addParentTags');
  const cancelBtn = document.getElementById('addParentCancel');

  if (!form) {
    console.error('addParentForm not found');
    return;
  }

  function toggleMode() {
    if (modeSelect.checked) {
      selectSection.style.display = '';
      createSection.style.display = 'none';
      select.required = true;
      nameInput.required = false;
    } else {
      selectSection.style.display = 'none';
      createSection.style.display = '';
      select.required = false;
      nameInput.required = true;
    }
  }

  modeSelect.addEventListener('change', toggleMode);
  modeCreate.addEventListener('change', toggleMode);

  function open(goalId){
    goalIdInput.value = goalId;
    modeSelect.checked = true;
    toggleMode();
    select.innerHTML = '<option value="">-- Select a goal --</option>';
    
    // Populate dropdown with all goals except the current goal and existing parents
    const currentGoal = GOALS.find(g => g.id === goalId);
    const existingParentIds = currentGoal ? (currentGoal.parent_names || []).map(name => {
      const goal = ALL_GOALS.find(g => g.name === name);
      return goal ? goal.id : null;
    }).filter(id => id !== null) : [];
    
    ALL_GOALS.forEach(goal => {
      if (goal.id !== goalId && !existingParentIds.includes(goal.id)) {
        const option = document.createElement('option');
        option.value = goal.id;
        option.textContent = goal.name;
        select.appendChild(option);
      }
    });
    
    // Reset create form
    nameInput.value = '';
    startInput.value = '';
    dueInput.value = '';
    descInput.value = '';
    displayInput.value = '1';
    tagsInput.value = '';
    
    modal.classList.remove('hidden');
  }

  function close(){
    modal.classList.add('hidden');
    form.reset();
    toggleMode();
  }

  cancelBtn.addEventListener('click', close);
  modal.addEventListener('click', e => { if(e.target === modal) close(); });

  async function handleSubmit() {
    const goalId = parseInt(goalIdInput.value);
    console.log('Handle submit - Goal ID:', goalId);
    if (!goalId) {
      alert('Invalid goal ID');
      return;
    }
    
    let resp;
    try {
      if (modeSelect.checked) {
        console.log('Mode: Select existing');
        // Select existing goal
        const parentId = parseInt(select.value);
        if (!parentId) {
          alert('Please select a parent goal');
          return;
        }
        console.log('Linking parent:', parentId);
        resp = await fetch(`/goals/${goalId}/add-parent/${parentId}`, {
          method: 'POST',
          headers: { 'Accept': 'application/json' }
        });
      } else {
        console.log('Mode: Create new');
        // Create new goal
        if (!nameInput.value.trim()) {
          alert('Please enter a goal name');
          nameInput.focus();
          return;
        }
        console.log('Creating goal with name:', nameInput.value.trim());
        const fd = new FormData();
        fd.append('name', nameInput.value.trim());
        fd.append('start_date', startInput.value);
        fd.append('due_date', dueInput.value);
        fd.append('description', descInput.value.trim());
        fd.append('display', displayInput.value || '1');
        fd.append('tags', tagsInput.value.trim());
        resp = await fetch(`/goals/${goalId}/create-and-link-parent`, {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'application/json' }
        });
      }
      
      console.log('Response status:', resp.status);
      if (!resp) {
        alert('No response from server');
        return;
      }
      
      const contentType = resp.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        const text = await resp.text();
        console.error('Non-JSON response:', text);
        alert('Server returned non-JSON response:\n' + text);
        return;
      }
      
      const data = await resp.json();
      console.log('Response data:', data);
      if (!resp.ok || !data.ok) {
        alert(data.error || 'Failed to add parent');
        return;
      }
      
      showToast('Parent added');
      location.reload();
    } catch (error) {
      console.error('Error adding parent:', error);
      alert('An error occurred: ' + error.message);
    }
  }

  form.addEventListener('submit', async (e) => {
    console.log('Form submit event triggered');
    e.preventDefault();
    e.stopPropagation();
    await handleSubmit();
  });
  
  // Also attach click handler to submit button as backup
  const submitBtn = form.querySelector('button[type="submit"]');
  if (submitBtn) {
    submitBtn.addEventListener('click', async (e) => {
      console.log('Submit button clicked');
      e.preventDefault();
      e.stopPropagation();
      await handleSubmit();
    });
  }

  document.querySelectorAll('.goal-add-parent').forEach(btn => {
    btn.addEventListener('click', () => open(parseInt(btn.dataset.id)));
  });
})();

// Add Child functionality
(function(){
  const modal = document.getElementById('addChildModal');
  const form = document.getElementById('addChildForm');
  const goalIdInput = document.getElementById('addChildGoalId');
  const select = document.getElementById('addChildSelect');
  const selectSection = document.getElementById('addChildSelectSection');
  const createSection = document.getElementById('addChildCreateSection');
  const modeSelect = document.getElementById('addChildModeSelect');
  const modeCreate = document.getElementById('addChildModeCreate');
  const nameInput = document.getElementById('addChildName');
  const startInput = document.getElementById('addChildStart');
  const dueInput = document.getElementById('addChildDue');
  const descInput = document.getElementById('addChildDesc');
  const displayInput = document.getElementById('addChildDisplay');
  const tagsInput = document.getElementById('addChildTags');
  const cancelBtn = document.getElementById('addChildCancel');

  if (!form) {
    console.error('addChildForm not found');
    return;
  }

  function toggleMode() {
    if (modeSelect.checked) {
      selectSection.style.display = '';
      createSection.style.display = 'none';
      select.removeAttribute('required');
      nameInput.removeAttribute('required');
      // Clear create form values when switching to select mode
      nameInput.value = '';
      startInput.value = '';
      dueInput.value = '';
      descInput.value = '';
      displayInput.value = '1';
      tagsInput.value = '';
    } else {
      selectSection.style.display = 'none';
      createSection.style.display = '';
      select.removeAttribute('required');
      nameInput.removeAttribute('required');
      // Clear select value when switching to create mode
      select.value = '';
    }
  }

  modeSelect.addEventListener('change', toggleMode);
  modeCreate.addEventListener('change', toggleMode);
  
  // Ensure initial state is correct
  toggleMode();

  function open(goalId){
    goalIdInput.value = goalId;
    
    // Reset form
    form.reset();
    
    // Set default mode to select
    modeSelect.checked = true;
    modeCreate.checked = false;
    
    // Populate dropdown with all goals except the current goal and existing children
    select.innerHTML = '<option value="">-- Select a goal --</option>';
    const currentGoal = GOALS.find(g => g.id === goalId);
    const existingChildIds = currentGoal ? (currentGoal.children_names || []).map(name => {
      const goal = ALL_GOALS.find(g => g.name === name);
      return goal ? goal.id : null;
    }).filter(id => id !== null) : [];
    
    ALL_GOALS.forEach(goal => {
      if (goal.id !== goalId && !existingChildIds.includes(goal.id)) {
        const option = document.createElement('option');
        option.value = goal.id;
        option.textContent = goal.name;
        select.appendChild(option);
      }
    });
    
    // Reset create form
    nameInput.value = '';
    startInput.value = '';
    dueInput.value = '';
    descInput.value = '';
    displayInput.value = '1';
    tagsInput.value = '';
    
    // Toggle mode to ensure correct display
    toggleMode();
    
    modal.classList.remove('hidden');
  }

  function close(){
    modal.classList.add('hidden');
    form.reset();
    toggleMode();
  }

  cancelBtn.addEventListener('click', close);
  modal.addEventListener('click', e => { if(e.target === modal) close(); });

  async function handleSubmit() {
    // Ensure mode is correctly set before validation
    toggleMode();
    
    const goalId = parseInt(goalIdInput.value);
    console.log('Handle submit - Goal ID:', goalId);
    if (!goalId) {
      alert('Invalid goal ID');
      return;
    }
    
    let resp;
    try {
      if (modeSelect.checked) {
        console.log('Mode: Select existing');
        // Select existing goal
        const childId = parseInt(select.value);
        if (!childId) {
          alert('Please select a child goal');
          select.focus();
          return;
        }
        console.log('Linking child:', childId);
        resp = await fetch(`/goals/${goalId}/add-child/${childId}`, {
          method: 'POST',
          headers: { 'Accept': 'application/json' }
        });
      } else {
        console.log('Mode: Create new');
        // Ensure create section is visible before validation
        if (createSection.style.display === 'none') {
          createSection.style.display = '';
        }
        // Create new goal
        if (!nameInput.value.trim()) {
          alert('Please enter a goal name');
          nameInput.focus();
          return;
        }
        console.log('Creating goal with name:', nameInput.value.trim());
        const fd = new FormData();
        fd.append('name', nameInput.value.trim());
        fd.append('start_date', startInput.value);
        fd.append('due_date', dueInput.value);
        fd.append('description', descInput.value.trim());
        fd.append('display', displayInput.value || '1');
        fd.append('tags', tagsInput.value.trim());
        resp = await fetch(`/goals/${goalId}/create-and-link-child`, {
          method: 'POST',
          body: fd,
          headers: { 'Accept': 'application/json' }
        });
      }
      
      console.log('Response status:', resp.status);
      if (!resp) {
        alert('No response from server');
        return;
      }
      
      const contentType = resp.headers.get('content-type') || '';
      if (!contentType.includes('application/json')) {
        const text = await resp.text();
        console.error('Non-JSON response:', text);
        alert('Server returned non-JSON response:\n' + text);
        return;
      }
      
      const data = await resp.json();
      console.log('Response data:', data);
      if (!resp.ok || !data.ok) {
        alert(data.error || 'Failed to add child');
        return;
      }
      
      showToast('Child added');
      location.reload();
    } catch (error) {
      console.error('Error adding child:', error);
      alert('An error occurred: ' + error.message);
    }
  }

  form.addEventListener('submit', async (e) => {
    console.log('Form submit event triggered');
    e.preventDefault();
    e.stopPropagation();
    await handleSubmit();
  });
  
  // Also attach click handler to submit button as backup
  const submitBtn = form.querySelector('button[type="submit"]');
  if (submitBtn) {
    submitBtn.addEventListener('click', async (e) => {
      console.log('Submit button clicked');
      e.preventDefault();
      e.stopPropagation();
      await handleSubmit();
    });
  }

  document.querySelectorAll('.goal-add-child').forEach(btn => {
    btn.addEventListener('click', () => open(parseInt(btn.dataset.id)));
  });
})();




// Toast helpers
const toast = document.getElementById('toast');
function showToast(msg='Saved'){
  toast.textContent = msg;
  toast.classList.remove('hidden');
  void toast.offsetWidth;
  toast.classList.add('show');
  setTimeout(()=>{
    toast.classList.remove('show');
    setTimeout(()=> toast.classList.add('hidden'), 300);
  }, 1600);
}



// Delete flow (robust - queries elements when needed)
function openDel(id, hasLinks){
  const delM = document.getElementById('goalDelModal');
  const delMsg = document.getElementById('goalDelMsg');
  const delConfirm = document.getElementById('gdel_confirm');
  const delCancel = document.getElementById('gdel_cancel');
  if (!delM || !delMsg || !delConfirm || !delCancel){ alert('Delete modal missing in DOM'); return; }
  window.__delGoalId = id;
  if (hasLinks) {
    delMsg.textContent = 'This goal is linked to other goals as parent or child and cannot be deleted.';
    delConfirm.style.display = 'none';
  } else {
    delMsg.textContent = 'Are you sure you want to delete this goal? This cannot be undone.';
    delConfirm.style.display = '';
  }
  delM.classList.remove('hidden');

  // one-time bindings (idempotent)
  if (!delM.__bound){
    delM.__bound = true;
    delCancel.addEventListener('click', ()=> delM.classList.add('hidden'));
    delM.addEventListener('click', e=>{ if (e.target === delM) delM.classList.add('hidden'); });
    delConfirm.addEventListener('click', async ()=>{
      const delId = window.__delGoalId;
      if (!delId) return;
      const resp = await fetch(`/goals/${delId}/delete-inline`, { method:'POST', headers:{ 'Accept':'application/json' } });
      const ct = (resp.headers.get('content-type')||'').toLowerCase();
      const txt = await resp.text();
      if (!ct.includes('application/json')) { alert('Server returned non-JSON:\n' + txt); return; }
      const data = JSON.parse(txt);
      if (!resp.ok || !data.ok) { alert(data.error || ('HTTP ' + resp.status)); return; }
      const row = document.querySelector(`tr[data-rowid="${delId}"]`) || document.querySelector(`button.g-del[data-id="${delId}"]`)?.closest('tr');
      if (row) row.parentNode.removeChild(row);
      delM.classList.add('hidden');
      if (typeof showToast === 'function') showToast('Goal deleted');
    });
  }
}

// Wire buttons to openDel
document.querySelectorAll('.g-del').forEach(b=>{
  b.addEventListener('click', ()=> openDel(parseInt(b.dataset.id,10), b.dataset.haslinks === '1'));
});

// Excel-style smart filters
(function() {
  const table = document.getElementById('goalsTable');
  if (!table) return;
  
  // Disable the default filter row from base.html
  table.dataset.hasFilterRow = '1';
  
  const tbody = table.tBodies[0];
  const filterRow = table.querySelector('.filter-row');
  if (!tbody || !filterRow) return;
  
  const filters = {}; // Store active filters: { colIndex: Set of allowed values }
  
  // Get unique values for a column
  function getUniqueValues(colIndex) {
    const values = new Set();
    Array.from(tbody.rows).forEach(row => {
      const cell = row.cells[colIndex];
      if (cell) {
        const text = (cell.textContent || '').trim();
        if (text) values.add(text);
      }
    });
    return Array.from(values).sort();
  }
  
  // Create filter dropdown for a column
  function createFilterDropdown(colIndex, headerText) {
    const th = filterRow.cells[colIndex];
    if (!th) return;
    
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.textContent = 'Filter';
    btn.type = 'button';
    
    const dropdown = document.createElement('div');
    dropdown.className = 'filter-dropdown';
    
    const search = document.createElement('input');
    search.type = 'text';
    search.className = 'filter-search';
    search.placeholder = 'Search...';
    
    const list = document.createElement('div');
    list.className = 'filter-list';
    
    const actions = document.createElement('div');
    actions.className = 'filter-actions';
    
    const selectAll = document.createElement('button');
    selectAll.type = 'button';
    selectAll.className = 'btn';
    selectAll.textContent = 'Select All';
    
    const clear = document.createElement('button');
    clear.type = 'button';
    clear.className = 'btn';
    clear.textContent = 'Clear';
    
    const apply = document.createElement('button');
    apply.type = 'button';
    apply.className = 'btn primary';
    apply.textContent = 'OK';
    
    actions.appendChild(selectAll);
    actions.appendChild(clear);
    actions.appendChild(apply);
    
    dropdown.appendChild(search);
    dropdown.appendChild(list);
    dropdown.appendChild(actions);
    
    th.appendChild(btn);
    th.appendChild(dropdown);
    
    let allValues = [];
    let checkboxes = [];
    let selectedValues = new Set();
    
    function buildList(filterText = '') {
      list.innerHTML = '';
      checkboxes = [];
      const filtered = allValues.filter(v => 
        v.toLowerCase().includes(filterText.toLowerCase())
      );
      
      filtered.forEach(value => {
        const item = document.createElement('div');
        item.className = 'filter-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = value;
        checkbox.checked = selectedValues.has(value) || selectedValues.size === 0;
        
        const label = document.createElement('label');
        label.textContent = value;
        label.style.cursor = 'pointer';
        label.style.flex = '1';
        label.addEventListener('click', () => checkbox.click());
        
        item.appendChild(checkbox);
        item.appendChild(label);
        list.appendChild(item);
        
        checkboxes.push(checkbox);
      });
    }
    
    function updateButton() {
      if (selectedValues.size === 0 || selectedValues.size === allValues.length) {
        btn.textContent = 'Filter';
        btn.classList.remove('active');
      } else {
        btn.textContent = `Filter (${selectedValues.size})`;
        btn.classList.add('active');
      }
    }
    
    // Initialize
    allValues = getUniqueValues(colIndex);
    buildList();
    updateButton();
    
    // Toggle dropdown
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      document.querySelectorAll('.filter-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
      });
      dropdown.classList.toggle('show');
    });
    
    // Search
    search.addEventListener('input', (e) => {
      buildList(e.target.value);
    });
    
    // Select All
    selectAll.addEventListener('click', () => {
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedValues.add(cb.value);
      });
    });
    
    // Clear
    clear.addEventListener('click', () => {
      checkboxes.forEach(cb => {
        cb.checked = false;
        selectedValues.delete(cb.value);
      });
    });
    
    // Checkbox changes
    list.addEventListener('change', (e) => {
      if (e.target.type === 'checkbox') {
        if (e.target.checked) {
          selectedValues.add(e.target.value);
        } else {
          selectedValues.delete(e.target.value);
        }
      }
    });
    
    // Apply
    apply.addEventListener('click', () => {
      filters[colIndex] = selectedValues.size > 0 ? selectedValues : null;
      applyFilters();
      dropdown.classList.remove('show');
      updateButton();
    });
    
    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });
  }
  
  // Apply filters
  function applyFilters() {
    Array.from(tbody.rows).forEach(row => {
      let show = true;
      for (const [colIndex, allowedValues] of Object.entries(filters)) {
        if (allowedValues === null) continue;
        const cell = row.cells[parseInt(colIndex)];
        if (cell) {
          const text = (cell.textContent || '').trim();
          if (!allowedValues.has(text)) {
            show = false;
            break;
          }
        }
      }
      row.style.display = show ? '' : 'none';
    });
  }
  
  // Create filters for each column (skip Edit column)
  const headerRow = table.tHead.rows[0];
  for (let i = 0; i < headerRow.cells.length - 1; i++) {
    const headerText = headerRow.cells[i].textContent.trim();
    if (headerText && headerText.toLowerCase() !== 'edit') {
      createFilterDropdown(i, headerText);
    }
  }
})();

</script>
{% endblock %}
